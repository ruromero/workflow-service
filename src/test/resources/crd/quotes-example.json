{
  "name": "OrderPlacement",
  "metadata": {
    "inputs": [
      {
        "name": "order",
        "fields": {
          "address": "address",
          "name": "string",
          "lastName": "string",
          "items": "list[item]",
          "totalCost": "number"
        }
      }, {
        "name": "address",
        "fields": {
          "street": "string",
          "city": "string",
          "zipcode": "string",
          "country": "string"
        }
      }, {
        "name": "item",
        "fields": {
          "code": "string",
          "name": "string",
          "price": "number"
        }
      }
    ]
  },
  "trigger-defs": {
    "json": {
      "source": "/quotes",
      "eventID": "json-event",
      "correlation-token": "json-event-token"
    },
    "kafka-create": {
      "source": "/apis/v1/namespaces/default/kafkasources/quotes#create",
      "eventID": "kafka-create",
      "correlation-token": "kafka-create-token"
    },
    "kafka-cancel": {
      "source": "/apis/v1/namespaces/default/kafkasources/quotes#cancel",
      "eventID": "kafka-cancel",
      "correlation-token": "kafka-cancel-token"
    }
  },
  "states": {
    "createQuote": {
      "type": "EVENT",
      "start": true,
      "events": [
        {
          "event-expression": "trigger.equals('kafka-create') or trigger.equals('json')",
          "action-mode": "Sequential",
          "actions": [
            {
              "function": "kie:kogito:service:ResolveZipCode",
               "metadata": {
                "input": "$.order.address.zipcode",
                "output": "$.result.country",
                "path": "$.order.address.country"
               }
            }, {
              "function": "kie:knative:service:local-shipment"
            }, {
              "function": "arn:aws:lambda:REGION:ACCOUNT_ID:function:calculate-shipment-cost"
            }
          ],
          "next-state": "specialQuoteCase"
        }
      ]
    },
    "cancelQuote": {
      "type": "EVENT",
      "start": true,
      "events": [
        {
          "event-expression": "trigger.equals('kafka-cancel')",
          "action-mode": "Sequential",
          "actions": [
            {
              "function": "kie:kogito:service:CancelShipment"
            }, {
              "function": "kie:kogito:service:EmailUser"
            }
          ],
          "next-state": "endState"
        }
      ]
    },
    "specialQuoteCase": {
      "type": "SWITCH",
      "choices": [
        {
          "path": "$.order.country",
          "operator": "EQ",
          "value": "ES",
          "next-state": "specialQuote"
        }
      ],
      "default": "endState"
    },
    "specialQuote": {
      "function": "kie:kogito:function:CalculatePromoDiscount",
      "next-state": "endState"
    },
    "endState": {
      "type": "END",
      "status": "SUCCESS"
    }
  }
}